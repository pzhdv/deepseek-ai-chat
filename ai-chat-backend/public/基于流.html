<!DOCTYPE html>
<html lang="zh-CN">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DeepSeek AI - æµå¼å“åº”æ¨¡å¼</title>
<link rel="icon"
  href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒŠ</text></svg>">
<script type="module">
  // é€šè¿‡ CDN å¼•å…¥EventSourceï¼ˆESM æ ¼å¼ï¼‰
  import { fetchEventSource } from 'https://cdn.jsdelivr.net/npm/@fortaine/fetch-event-source@3.0.6/+esm'
  Window.fetchEventSource = fetchEventSource // æŒ‚è½½åˆ°Windowä¸Š
</script>
<!-- Markdown æ¸²æŸ“åº“ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- ä»£ç é«˜äº®åº“ å®˜æ–¹ CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<style>
  :root {
    --primary-color: #2d8cf0;
    --secondary-color: #52c41a;
    --danger-color: #ff4d4f;
    --warning-color: #faad14;
    --bot-bg: #f5f5f5;
    --user-bg: #e6f7ff;
    --error-bg: #fff2f0;
    --success-bg: #f6ffed;
    --stream-color: #722ed1;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f8f9fa;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  .header {
    background: linear-gradient(135deg, var(--stream-color), #9254de);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px rgba(114, 46, 209, 0.2);
  }

  .header-title {
    font-size: 1.2rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .header-actions {
    display: flex;
    gap: 0.5rem;
  }

  .header-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 0.5rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9rem;
  }

  .header-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-1px);
  }

  .chat-container {
    max-width: 800px;
    margin: 20px auto;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    flex: 1;
    display: flex;
    flex-direction: column;
    width: 95%;
    overflow: hidden;
  }

  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .message {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 15px;
    line-height: 1.5;
    animation: fadeIn 0.3s ease;
  }

  .bot-message {
    background: var(--bot-bg);
    align-self: flex-start;
    border-bottom-left-radius: 3px;
  }

  .user-message {
    background: var(--user-bg);
    align-self: flex-end;
    border-bottom-right-radius: 3px;
  }

  .typing-indicator {
    display: none;
    padding: 12px 20px;
    color: #666;
    font-style: italic;
    background: rgba(114, 46, 209, 0.05);
    border-left: 3px solid var(--stream-color);
    margin: 0 20px;
    border-radius: 8px;
    align-items: center;
    gap: 10px;
  }

  .typing-dots {
    display: inline-flex;
    gap: 4px;
    margin-right: 8px;
  }

  .typing-dots span {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--stream-color);
    animation: typing 1.4s infinite ease-in-out;
  }

  .typing-dots span:nth-child(1) {
    animation-delay: -0.32s;
  }

  .typing-dots span:nth-child(2) {
    animation-delay: -0.16s;
  }

  @keyframes typing {

    0%,
    80%,
    100% {
      transform: scale(0.8);
      opacity: 0.5;
    }

    40% {
      transform: scale(1);
      opacity: 1;
    }
  }

  .error-message {
    background: var(--error-bg);
    border-left: 3px solid var(--danger-color);
    color: #a8071a;
  }

  .success-message {
    background: var(--success-bg);
    border-left: 3px solid var(--secondary-color);
    color: #389e0d;
  }

  .stop {
    padding: 0.5rem 1rem;
    background: var(--danger-color);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
  }

  .stop:hover {
    background: #d32029;
    transform: translateY(-1px);
  }

  .stop:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .input-container {
    border-top: 1px solid #eee;
    padding: 15px;
    display: flex;
    gap: 10px;
  }

  #messageInput {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    resize: none;
    min-height: 48px;
    max-height: 120px;
  }

  #sendButton {
    padding: 0 20px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  #sendButton:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .stop {
    align-items: center;
    display: flex;
    cursor: pointer;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 480px) {
    .message {
      max-width: 90%;
    }
  }
</style>
</head>

<body>
  <div class="chat-container">
    <div class="header">
      <div class="header-title">
        ğŸŒŠ æµå¼å“åº”æ¨¡å¼
      </div>
      <div class="header-actions">
        <button class="header-btn" onclick="clearChat()" title="æ¸…ç©ºå¯¹è¯">
          ğŸ—‘ï¸ æ¸…ç©º
        </button>
        <button class="header-btn" onclick="goHome()" title="è¿”å›é¦–é¡µ">
          ğŸ  é¦–é¡µ
        </button>
        <button class="header-btn" onclick="switchMode()" title="åˆ‡æ¢åˆ°æ–‡æœ¬æ¨¡å¼">
          ğŸ“ æ–‡æœ¬
        </button>
      </div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="typing-indicator" id="typing">
      <div class="typing-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
      DeepSeek æ­£åœ¨å®æ—¶è¾“å‡º...
    </div>
    <div class="input-container">
      <textarea id="messageInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." rows="1" onkeydown="handleKeyDown(event)"></textarea>
      <button id="sendButton" onclick="sendMessageByFetch()">
        <span id="sendText">å‘é€</span>
        <span id="sendIcon">ğŸš€</span>
      </button>
      <button class="stop" onclick="cancelRequest()" title="åœæ­¢ç”Ÿæˆ">
        â¹ï¸
      </button>
    </div>
  </div>

  <script>
    // ========== å…¨å±€å˜é‡ ==========
    let ctrl; // ç”¨äºä¸­æ–­è¯·æ±‚çš„AbortControllerå®ä¾‹

    // ========== DOM å…ƒç´ è·å– ==========
    const messagesEl = document.getElementById('messages');  // æ¶ˆæ¯å®¹å™¨å…ƒç´ 
    const inputEl = document.getElementById('messageInput'); // è¾“å…¥æ¡†å…ƒç´ 
    inputEl.value = "jså†™ä¸€ä¸ªäºŒåˆ†æŸ¥æ‰¾" // ç»™inputèµ‹åˆå§‹å€¼
    const sendBtn = document.getElementById('sendButton');   // å‘é€æŒ‰é’®å…ƒç´ 
    const typingEl = document.getElementById('typing');      // æ­£åœ¨è¾“å…¥æç¤ºå…ƒç´ 

    // ========== è¾“å…¥æ¡†è‡ªé€‚åº”é«˜åº¦ ==========
    // ç›‘å¬è¾“å…¥æ¡†å†…å®¹å˜åŒ–ï¼Œè‡ªåŠ¨è°ƒæ•´é«˜åº¦ä»¥é€‚åº”å¤šè¡Œæ–‡æœ¬
    inputEl.addEventListener('input', () => {
      inputEl.style.height = 'auto';                        // é‡ç½®é«˜åº¦
      inputEl.style.height = inputEl.scrollHeight + 'px';   // æ ¹æ®å†…å®¹è®¾ç½®é«˜åº¦
    });

    // ========== æ¶ˆæ¯æ˜¾ç¤ºåŠŸèƒ½ ==========
    /**
     * æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©æ¡†
     * @param {string} content - æ¶ˆæ¯å†…å®¹
     * @param {boolean} isUser - æ˜¯å¦ä¸ºç”¨æˆ·æ¶ˆæ¯
     */
    function addMessage(content, isUser) {
      // åˆ›å»ºæ¶ˆæ¯å®¹å™¨å…ƒç´ 
      const messageDiv = document.createElement('div');
      // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®CSSç±»å
      messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
      // ä½¿ç”¨markedåº“è§£æMarkdownæ ¼å¼çš„å†…å®¹
      messageDiv.innerHTML = marked.parse(content);
      // å°†æ¶ˆæ¯æ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨ä¸­
      messagesEl.appendChild(messageDiv);

    }



    // ========== Fetchæµå¼è¯·æ±‚æ–¹æ³• ==========
    /**
     * é€šè¿‡fetchå‘é€æ¶ˆæ¯åˆ°åç«¯å¹¶æ¥æ”¶æµå¼å“åº”æ•°æ®
     * ä½¿ç”¨åŸç”Ÿfetch APIå¤„ç†Server-Sent Eventsæµ
     */
    async function sendMessageByFetch() {
      // è·å–å¹¶éªŒè¯è¾“å…¥å†…å®¹
      const content = inputEl.value.trim();
      if (!content || sendBtn.disabled) return;

      // ========== UIçŠ¶æ€åˆå§‹åŒ– ==========
      inputEl.value = '';                    // æ¸…ç©ºè¾“å…¥æ¡†
      inputEl.style.height = 'auto';         // é‡ç½®è¾“å…¥æ¡†é«˜åº¦
      sendBtn.disabled = true;               // ç¦ç”¨å‘é€æŒ‰é’®

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
      addMessage(content, true);

      // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æç¤ºå¹¶æ»šåŠ¨åˆ°åº•éƒ¨
      typingEl.style.display = 'block';
      console.log("ç”¨æˆ·è¯·æ±‚æ•°æ®:", content)

      // åˆ›å»ºä¸­æ–­æ§åˆ¶å™¨ï¼Œç”¨äºå–æ¶ˆè¯·æ±‚
      ctrl = new AbortController()

      try {
        // ========== å‘èµ·æµå¼APIè¯·æ±‚ ==========
        const response = await fetch('/api/ai/chat-stream-deepseek', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            "messages": [
              { "role": "system", "content": "You are a helpful assistant." },
              { "role": "user", "content": content }
            ]
          }),
          signal: ctrl.signal,  // ç»‘å®šä¸­æ–­ä¿¡å·
        })

        // ========== HTTPçŠ¶æ€ç å¼‚å¸¸å¤„ç† ==========
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${response.statusText}${errorText ? ' - ' + errorText : ''}`);
        }

        // ========== æµè¯»å–å¼‚å¸¸å¤„ç† ==========
        if (!response.body) {
          throw new Error('å“åº”ä½“ä¸ºç©ºï¼Œæ— æ³•è¯»å–æµæ•°æ®');
        }

        // ========== å¤„ç†æµå¼å“åº”æ•°æ® ==========
        const reader = response.body.getReader();  // è·å–å“åº”æµè¯»å–å™¨
        const decoder = new TextDecoder();         // åˆ›å»ºæ–‡æœ¬è§£ç å™¨
        let botResponse = '';                      // ç´¯ç§¯AIå›å¤å†…å®¹

        try {
          // æŒç»­è¯»å–æµæ•°æ®
          while (true) {
            const { done, value } = await reader.read();  // è¯»å–æ•°æ®å—
            if (done) break;  // æµç»“æŸæ—¶é€€å‡ºå¾ªç¯

            // ========== æ•°æ®è§£ç å¼‚å¸¸å¤„ç† ==========
            let chunk;
            try {
              chunk = decoder.decode(value);
            } catch (decodeError) {
              console.error('æ•°æ®è§£ç å¤±è´¥:', decodeError);
              continue; // è·³è¿‡å½“å‰æ•°æ®å—ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª
            }

            const lines = chunk.split('\n').filter(l => l.trim());

            // å¤„ç†æ¯ä¸€è¡Œæ•°æ®
            for (const line of lines) {
              const message = line.replace(/^data: /, '');  // ç§»é™¤SSEæ ¼å¼å‰ç¼€
              if (message === '[DONE]') break;             // æ£€æŸ¥ç»“æŸæ ‡å¿—

              // ========== JSONè§£æå¼‚å¸¸å¤„ç† ==========
              try {
                const data = JSON.parse(message);

                // ========== æ•°æ®æ ¼å¼éªŒè¯ ==========
                if (!data || typeof data.content === 'undefined') {
                  console.warn('æ•°æ®æ ¼å¼å¼‚å¸¸:', data);
                  continue; // è·³è¿‡æ ¼å¼å¼‚å¸¸çš„æ•°æ®
                }

                botResponse += data.content;

                // ========== å®æ—¶UIæ›´æ–° ==========
                const lastMsg = messagesEl.lastChild;
                if (lastMsg && !lastMsg.classList.contains('user-message')) {
                  // æ›´æ–°ç°æœ‰æ¶ˆæ¯å†…å®¹ï¼ˆé€å­—æ˜¾ç¤ºæ•ˆæœï¼‰
                  lastMsg.innerHTML = marked.parse(botResponse)
                  hljs.highlightAll(); // é‡æ–°é«˜äº®ä»£ç å—
                } else {
                  // åˆ›å»ºæ–°çš„AIæ¶ˆæ¯
                  addMessage(marked.parse(botResponse), false);
                }

              } catch (parseError) {
                console.error('JSONè§£æé”™è¯¯:', parseError, 'åŸå§‹æ•°æ®:', message);
                // ç»§ç»­å¤„ç†ä¸‹ä¸€è¡Œæ•°æ®ï¼Œä¸ä¸­æ–­æ•´ä¸ªæµç¨‹
              }
            }
          }
        } finally {
          // ç¡®ä¿é‡Šæ”¾æµè¯»å–å™¨èµ„æº
          reader.releaseLock();
        }

        // ========== æµæ•°æ®å®Œæ•´æ€§æ£€æŸ¥ ==========
        if (!botResponse.trim()) {
          throw new Error('æœªæ”¶åˆ°æœ‰æ•ˆçš„å“åº”æ•°æ®');
        }

      } catch (error) {
        // ========== ç»Ÿä¸€å¼‚å¸¸å¤„ç† ==========
        console.error('æµå¼è¯·æ±‚å¼‚å¸¸:', error);

        // æ’é™¤ç”¨æˆ·ä¸»åŠ¨ä¸­æ–­çš„æƒ…å†µ
        if (error.name === 'AbortError') {
          console.log('ç”¨æˆ·å–æ¶ˆäº†è¯·æ±‚');
          return;
        }

        let errorMessage = 'æµå¼è¯·æ±‚å¤±è´¥';

        // ç½‘ç»œè¿æ¥å¼‚å¸¸
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
        }
        // HTTPçŠ¶æ€ç å¼‚å¸¸
        else if (error.message.includes('HTTP')) {
          errorMessage = `æœåŠ¡å™¨é”™è¯¯: ${error.message}`;
        }
        // æµè¯»å–å¼‚å¸¸
        else if (error.message.includes('å“åº”ä½“ä¸ºç©º')) {
          errorMessage = 'æœåŠ¡å™¨æœªè¿”å›æµæ•°æ®';
        }
        // æ•°æ®å®Œæ•´æ€§å¼‚å¸¸
        else if (error.message.includes('æœªæ”¶åˆ°æœ‰æ•ˆçš„å“åº”æ•°æ®')) {
          errorMessage = 'æœåŠ¡å™¨å“åº”æ•°æ®ä¸ºç©º';
        }
        // å…¶ä»–æœªçŸ¥å¼‚å¸¸
        else {
          errorMessage = `æµå¤„ç†é”™è¯¯: ${error.message}`;
        }

        addMessage(`âŒ ${errorMessage}`, false);
      } finally {
        // ========== æ¸…ç†å·¥ä½œ ==========
        typingEl.style.display = 'none';  // éšè—è¾“å…¥æç¤º
        sendBtn.disabled = false;         // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
      }
    }

    // ========== EventSourceæµå¼è¯·æ±‚æ–¹æ³• ==========
    /**
     * é€šè¿‡EventSourceå‘é€æ¶ˆæ¯åˆ°åç«¯å¹¶æ¥æ”¶æµå¼å“åº”æ•°æ®
     * ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“fetchEventSourceæ”¯æŒPOSTè¯·æ±‚çš„Server-Sent Events
     */
    async function sendMessageByEventSource() {
      // è·å–å¹¶éªŒè¯è¾“å…¥å†…å®¹
      const content = inputEl.value.trim();
      if (!content || sendBtn.disabled) return;

      // ========== UIçŠ¶æ€åˆå§‹åŒ– ==========
      inputEl.value = '';                    // æ¸…ç©ºè¾“å…¥æ¡†
      inputEl.style.height = 'auto';         // é‡ç½®è¾“å…¥æ¡†é«˜åº¦
      sendBtn.disabled = true;               // ç¦ç”¨å‘é€æŒ‰é’®

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
      addMessage(content, true);

      // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æç¤ºå¹¶æ»šåŠ¨åˆ°åº•éƒ¨
      typingEl.style.display = 'block';

      console.log("ç”¨æˆ·è¯·æ±‚æ•°æ®:", content)
      // åˆ›å»ºä¸­æ–­æ§åˆ¶å™¨ï¼Œç”¨äºå–æ¶ˆè¯·æ±‚
      ctrl = new AbortController()
      let botResponse = '';  // ç´¯ç§¯AIå›å¤å†…å®¹

      // ========== åˆ›å»ºEventSourceè¿æ¥ ==========
      // ä½¿ç”¨fetchEventSourceåº“æ”¯æŒPOSTæ–¹æ³•çš„Server-Sent Events
      Window.fetchEventSource('/api/ai/chat-stream-deepseek', {
        method: 'POST',       // ä½¿ç”¨POSTæ–¹æ³•å‘é€æ•°æ®
        headers: {
          'Content-Type': 'application/json',  // è®¾ç½®è¯·æ±‚å¤´
        },
        body: JSON.stringify({
          "messages": [
            { "role": "system", "content": "You are a helpful assistant." },
            { "role": "user", "content": content }
          ]
        }), // è¯·æ±‚ä½“æ•°æ®
        signal: ctrl.signal,  // ç»‘å®šä¸­æ–­ä¿¡å·ï¼Œæ”¯æŒå–æ¶ˆè¯·æ±‚

        // ========== è¿æ¥å»ºç«‹å›è°ƒ ==========
        onopen: async (response) => {
          // è¿æ¥æˆåŠŸæ—¶è§¦å‘æ­¤å›è°ƒ
          console.log('SSE è¿æ¥å·²å»ºç«‹ï¼ŒçŠ¶æ€ç :', response.status);
          if (response.ok) return;         // çŠ¶æ€æ­£å¸¸åˆ™ç»§ç»­å¤„ç†
          throw new Error('è¿æ¥å¤±è´¥');     // è¿æ¥å¤±è´¥åˆ™æŠ›å‡ºé”™è¯¯
        },

        // ========== æ¶ˆæ¯æ¥æ”¶å›è°ƒ ==========
        onmessage: (event) => {
          try {
            // æ¯æ¬¡æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯æ—¶è§¦å‘
            console.log('æ”¶åˆ°äº‹ä»¶:', event.data);

            // ========== JSONè§£æå¼‚å¸¸å¤„ç† ==========
            let data;
            try {
              data = JSON.parse(event.data);
            } catch (parseError) {
              console.error('EventSource JSONè§£æé”™è¯¯:', parseError, 'åŸå§‹æ•°æ®:', event.data);
              return; // è·³è¿‡å½“å‰æ¶ˆæ¯ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª
            }

            // ========== æ•°æ®æ ¼å¼éªŒè¯ ==========
            if (!data || typeof data.content === 'undefined') {
              console.warn('EventSourceæ•°æ®æ ¼å¼å¼‚å¸¸:', data);
              return; // è·³è¿‡æ ¼å¼å¼‚å¸¸çš„æ•°æ®
            }

            botResponse += data.content;          // ç´¯ç§¯å›å¤å†…å®¹

            // ========== å®æ—¶UIæ›´æ–° ==========
            const lastMsg = messagesEl.lastChild;
            if (lastMsg && !lastMsg.classList.contains('user-message')) {
              // æ›´æ–°ç°æœ‰AIæ¶ˆæ¯å†…å®¹ï¼ˆå®ç°é€å­—æ˜¾ç¤ºæ•ˆæœï¼‰
              try {
                lastMsg.innerHTML = marked.parse(botResponse)
                hljs.highlightAll(); // é‡æ–°é«˜äº®ä»£ç å—
              } catch (renderError) {
                console.error('Markdownæ¸²æŸ“é”™è¯¯:', renderError);
                // ä½¿ç”¨çº¯æ–‡æœ¬ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                lastMsg.textContent = botResponse;
              }
            } else {
              // åˆ›å»ºæ–°çš„AIæ¶ˆæ¯
              try {
                addMessage(botResponse, false);
              } catch (addError) {
                console.error('æ·»åŠ æ¶ˆæ¯é”™è¯¯:', addError);
              }
            }
          } catch (error) {
            console.error('æ¶ˆæ¯å¤„ç†å¼‚å¸¸:', error);
            // ä¸ä¸­æ–­è¿æ¥ï¼Œç»§ç»­å¤„ç†åç»­æ¶ˆæ¯
          }
        },

        // ========== é”™è¯¯å¤„ç†å›è°ƒ ==========
        onerror: (err) => {
          console.error('SSEè¿æ¥é”™è¯¯:', err);

          let errorMessage = 'EventSourceè¿æ¥å¤±è´¥';

          // ========== é”™è¯¯ç±»å‹åˆ¤æ–­ ==========
          if (err && err.message) {
            if (err.message.includes('network')) {
              errorMessage = 'ç½‘ç»œè¿æ¥ä¸­æ–­ï¼Œè¯·æ£€æŸ¥ç½‘ç»œçŠ¶æ€';
            } else if (err.message.includes('timeout')) {
              errorMessage = 'è¿æ¥è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•';
            } else if (err.message.includes('abort')) {
              errorMessage = 'è¿æ¥è¢«ä¸­æ–­';
            } else {
              errorMessage = `è¿æ¥é”™è¯¯: ${err.message}`;
            }
          }

          addMessage(`âŒ ${errorMessage}`, false);
          throw err; // æŠ›å‡ºé”™è¯¯åœæ­¢è‡ªåŠ¨é‡è¯•
        },

        // ========== è¿æ¥å…³é—­å›è°ƒ ==========
        onclose: () => {
          // è¿æ¥å…³é—­æ—¶è§¦å‘æ¸…ç†å·¥ä½œ
          console.log('SSE è¿æ¥å·²å…³é—­');
          typingEl.style.display = 'none';  // éšè—è¾“å…¥æç¤º
          sendBtn.disabled = false;         // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
        }
      });
    }

    // ========== è¯·æ±‚å–æ¶ˆåŠŸèƒ½ ==========
    /**
     * å–æ¶ˆå½“å‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚
     * é€šè¿‡AbortControllerä¸­æ–­fetchæˆ–EventSourceè¿æ¥
     */
    function cancelRequest() {
      // æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„è¯·æ±‚æ§åˆ¶å™¨
      if (!ctrl) {
        return
      }
      console.log("å–æ¶ˆè¯·æ±‚")
      // ä¸­æ–­å½“å‰è¯·æ±‚
      ctrl.abort();
      // é‡ç½®UIçŠ¶æ€
      typingEl.style.display = 'none';  // éšè—è¾“å…¥æç¤º
      sendBtn.disabled = false;         // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
    }

    // ========== å·¥å…·å‡½æ•° ==========
    /**
     * æ¸…ç©ºèŠå¤©è®°å½•
     */
    function clearChat() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ')) {
        messagesEl.innerHTML = '';
        console.log('èŠå¤©è®°å½•å·²æ¸…ç©º');
      }
    }

    /**
     * è¿”å›é¦–é¡µ
     */
    function goHome() {
      window.location.href = '/';
    }

    /**
     * åˆ‡æ¢åˆ°æ–‡æœ¬æ¨¡å¼
     */
    function switchMode() {
      window.location.href = '/åŸºäºæ–‡æœ¬.html';
    }

    // ========== é¡µé¢åˆå§‹åŒ– ==========
    document.addEventListener('DOMContentLoaded', () => {
      // èšç„¦è¾“å…¥æ¡†
      inputEl.focus();

      // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
      setTimeout(() => {
        addMessage('ğŸŒŠ æ¬¢è¿ä½¿ç”¨ DeepSeek AI æµå¼å“åº”æ¨¡å¼ï¼\n\nåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼ŒAI ä¼šå®æ—¶é€å­—è¾“å‡ºå›ç­”ï¼Œå°±åƒçœŸäººåœ¨æ‰“å­—ä¸€æ ·ã€‚æ‚¨å¯ä»¥ï¼š\n\nâ€¢ è¾“å…¥ä»»ä½•é—®é¢˜æˆ–è¯·æ±‚\n\nâ€¢  ç‚¹å‡»åœæ­¢æŒ‰é’®ä¸­æ–­ç”Ÿæˆ\n\nä½“éªŒæµç•…çš„å¯¹è¯æ„Ÿå—å§ï¼', false);
      }, 500);
    });
  </script>
</body>

</html>